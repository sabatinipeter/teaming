var teaming = {};

teaming.teams = [
    {
        "name":"Route One Desking",
        "roles":["DL", "Dev", "Dev"]
    },
    {
        "name":"Route One Menu",
        "roles":["DL", "DL", "Dev", "Dev", "Dev", "Dev", "Apr"]
    },
    {
        "name":"ACSI",
        "roles":["DL", "TL", "Dev", "Dev", "Dev", "Dev", "Dev","Dev", "XD", "XD"]
    },
    {
        "name":"JIS",
        "roles":["DM", "DL", "DL", "TL", "Dev", "Dev", "Dev", "Dev", "Dev", "Dev", "Dev", "XD"]
    },
    {
        "name":"Ford - FMCC",
        "roles":["DM", "DL", "Dev", "Dev", "Dev", "1/2 Dev"]
    },
    {
        "name":"Ford - GForce",
        "roles":["DM", "DL", "TL", "BA", "Dev", "Dev", "Dev", "1/2 Dev", "1/2 Dev"]
    },
    {
        "name":"Ford - Agile COE",
        "roles":["Other", "Other", "Other"]

    },
    {
        "name":"Ford - Falcon",
        "roles":["DL", "Dev", "Dev", "Dev"]
    },
    {
        "name":"Ford - PDO",
        "roles":["Other", "Other"]
    }
    ];

teaming.people = [{
      "name": "Matt Staffeld",
      "image": "images/matthewstaffeld.png",
      "position": "Software Journeyman",
      "notes":  "Javascript"
  },{
      "name": "Bree Lane",
      "image": "images/breelane.jpg",
      "position": "Delivery Lead",
      "notes": "Git"
  },{
      "name": "Adam Gartee",
      "image": "images/adamgartee.png",
      "position": "Software Journeyman",
      "notes": ".net"
  },{
      "name": "Aladin Gohar",
      "image": "images/aladingohar.jpg",
      "position": "Delivery Manager"
  },{
      "name": "Amitai Schleier",
      "image": "images/amitaischleier.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Angela Peat",
      "image": "images/angelapeat.png",
      "position": "Delivery Lead"
  },{
      "name": "Aziz Harawala",
      "image": "images/azizhararwala.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Ben Tidman",
      "image": "images/bentidman.jpg",
      "position": "Software Journeyman",
      "notes":  "Javascript"
  },{
      "name": "Bill Koester",
      "image": "images/billkoester.jpg",
      "position": "Software Journeyman"
  },{
      "name": "Brett Lilley",
      "image": "images/brettlilley.jpg",
      "position": "Software Journeyman",
      "notes": ".net"
  },{
      "name": "Chris Atkins",
      "image": "images/chrisatkins.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Christopher Bibbs",
      "image": "images/christopherbibbs.png",
      "position": "Delivery Lead"
  },{
      "name": "Clay Dowling",
      "image": "images/claydowling.jpg",
      "position": "Software Journeyman"
  },{
      "name": "Dan Davis",
      "image": "images/dandavis.png",
      "position": "Delivery Lead"
  },{
      "name": "Dan Putman",
      "image": "images/danputman.png",
      "position": "Software Craftsman",
      "notes": "beard"
  },{
      "name": "David Zuidema",
      "image": "images/davidzuidema.jpeg",
      "position": "Software Journeyman"
  },{
      "name": "Edwin Aoraha",
      "image": "images/edwinaoraha.png",
      "position": "Software Apprentice"
  },{
      "name": "Erik Przekop",
      "image": "images/erikprzekop.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Fred Estabrook",
      "image": "images/fredestabrook.png",
      "position": "Delivery Lead"
  },{
      "name": "Gabe Ilko",
      "image": "images/gabeIlko.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Jeeva Adarahah",
      "image": "images/jeevanadarahah.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Jeff Hoover",
      "image": "images/jeffhoover.png",
      "position": "Software Journeyman"
  },{
      "name": "Jennifer Folkerth",
      "image": "images/jenniferfolkerth.jpg",
      "position": "Software Journeyman"
  },{
      "name": "Joe Dluzen",
      "image": "images/joedluzen.jpg",
      "position": "Software Journeyman"
  },{
      "name": "John Gartee",
      "image": "images/johngartee.png",
      "position": "Software Craftsman",
      "notes": "beard"
  },{
      "name": "Jonathan Baugh",
      "image": "images/jonathanbaugh.jpg",
      "position": "Delivery Lead/Experience Architect",
      "notes": "beard"
  },{
      "name": "Josh Bechard",
      "image": "images/joshbechard.jpg",
      "position": "Software Journeyman"
  },{
      "name": "Josh Ribolla",
      "image": "images/joshribolla.jpg",
      "position": "Experience Architect"
  },{
      "name": "Mark Henke",
      "image": "images/markhenke.jpg",
      "position": "Software Journeyman",
      "notes": "beard"
  },{
      "name": "Mark Protas",
      "image": "images/markprotas.jpg",
      "position": "Software Craftsman",
      "notes": "Java beard"
  },{
      "name": "Meera Srinivasan",
      "image": "images/meerasrinivasan.png",
      "position": "Delivery Lead"
  },{
      "name": "Michele Cresmen-Block",
      "image": "images/michelecresmenblock.png",
      "position": "Delivery Manager"
  },{
      "name": "Paul Glinski",
      "image": "images/paulglinski.jpg",
      "position": "Software Journeyman"
  },{
      "name": "Peter Sabatini",
      "image": "images/petersabatini.png",
      "position": "Software Journeyman",
      "notes": "Javascript"
  },{
      "name": "Ralph Hale",
      "image": "images/ralphhale.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Rob Murdock",
      "image": "images/robmurdock.png",
      "position": "Software Craftsman",
      "notes": "beard"
  },{
      "name": "Stephen Cavaliere",
      "image": "images/stephencavaliere.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Theo Chupp",
      "image": "images/theochupp.jpg",
      "position": "Software Journeyman",
      "notes": "beard"
  },{
      "name": "Todd Hurley",
      "image": "images/toddhurley.jpg",
      "position": "Software Craftsman"
  },{
      "name": "Tom Puricelli",
      "image": "images/tompuricelli.jpg",
      "position": "Delivery Lead"
  },{
      "name": "Will Gibbins",
      "image": "images/willgibbins.jpg",
      "position": "Delivery Lead",
      "notes": "beard"
  },{
      "name": "Adam Crane",
      "image": "images/AdamCranePhoto.jpg",
      "position": "Software Journeyman",
      "notes":  ""
    },{
        "name": "Andrew Howard",
        "image": "images/new.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Aravind Balasubramanian",
        "image": "images/Aravind.jpg",
        "position": "Executive Consultant",
        "notes":  ""
    },{
        "name": "Bobby Baker",
        "image": "images/bobBrick.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Brandon Zeeb",
        "image": "images/BrandonZeeb.jpg",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Butch Howard",
        "image": "images/ButchHoward.jpg",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Charlie Snider",
        "image": "images/charlessnider.png",
        "position": "Delivery Lead",
        "notes":  ""
    },{
        "name": "Cheryl Smith",
        "image": "images/cherylsmith.jpg",
        "position": "Delivery Lead",
        "notes":  ""
    },{
        "name": "Chris Baker",
        "image": "images/chrisbaker.jpg",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Chris Bernholt",
        "image": "images/ChrisBernholt.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Connor Sweeney",
        "image": "images/ConnorSweeney.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "DJ Daugherty",
        "image": "images/djdaugherty.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Dan Wiebe",
        "image": "images/new.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Daniel Wagers",
        "image": "images/DanWagers.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "David Kaye",
        "image": "images/davidkaye.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "David Nippa",
        "image": "images/DavidNippa.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "David Weirich",
        "image": "images/DavidWeirich.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Derek Nixon",
        "image": "images/DerekNixon.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Dicko Sow",
        "image": "images/DickoSow.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Drew Keller",
        "image": "images/drewkeller.jpg",
        "position": "Software Apprentice",
        "notes":  ""
    },{
        "name": "Hugo Fernandez",
        "image": "images/new.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "JD Sallee",
        "image": "images/JDsalle.png",
        "position": "Strategy Vanguard",
        "notes":  ""
    },{
        "name": "Jason Waack",
        "image": "images/jasonwaack.jpg",
        "position": "Executive Consultant",
        "notes":  ""
    },{
        "name": "Jennifer Kron",
        "image": "images/jenniferkron.jpg",
        "position": "Software Apprentice",
        "notes":  ""
    },{
        "name": "Jim Holmes",
        "image": "images/JimHolmes.jpg",
        "position": "Executive Consultant",
        "notes":  ""
    },{
        "name": "Joe Gilsenan",
        "image": "images/new.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "John Gartee",
        "image": "images/johngartee.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Justin Fitins",
        "image": "images/new.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Kristen Smith",
        "image": "images/kristensmith.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Lyman Gillespie",
        "image": "images/LymanGillispie.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Magnus Stahre",
        "image": "images/MagnusStahre.jpg",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Mark Holtman",
        "image": "images/MarkHoltman.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Mark Vertido",
        "image": "images/new.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Matt Manger",
        "image": "images/MattManger.png",
        "position": "Delivery Lead",
        "notes":  ""
    },{
        "name": "Nate Dubetz",
        "image": "images/natedubetz.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Nathan Bradshaw",
        "image": "images/nbradshaw.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Nathan Carver",
        "image": "images/nathancarver.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Ovi Sofariu",
        "image": "images/ovisofariu.png",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Paul Schwendenman",
        "image": "images/PaulSchwendenman.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Rick Ucker",
        "image": "images/RickUcker.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    },{
        "name": "Rob Conaway",
        "image": "images/robconaway.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Rob Hermance-Moore",
        "image": "images/robhermancemoore.png",
        "position": "Deliver Lead",
        "notes":  ""
    },{
        "name": "Rob Huston",
        "image": "images/robhuston.jpg",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Ruben Ojeda",
        "image": "images/rubenojeda.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Schonne Eldridge",
        "image": "images/SchonneEldridge.jpg",
        "position": "Experience Designer",
        "notes":  ""
    },{
        "name": "William Guynes",
        "image": "images/williamguynes.png",
        "position": "Software Craftsman",
        "notes":  ""
    },{
        "name": "Zach Brown",
        "image": "images/ZachBrown.jpg",
        "position": "Software Journeyman",
        "notes":  ""
    }
];

teaming.newPerson = {
    "name": "New Pillarite",
    "image": "images/new.jpg",
    "position": "Software Journeyman"
};

teaming.addNewPerson = function(person) {
    $('#peopleDiv').append(teaming.renderPersonTemplate(person, guid()));
};

teaming.addNewTeam = function(team) {
    $('#teamDiv').append(teaming.renderTeamTemplate(team, guid()));
}

teaming.renderPeople = function () {
    teaming.renderItems('#peopleDiv', teaming.people, teaming.renderPersonTemplate);
};

teaming.renderTeams = function() {
    teaming.renderItems('#teamDiv', teaming.teams, teaming.renderTeamTemplate);
};

teaming.renderItems = function(targetDiv, collection, renderFunction) {
    var html = "";
    var id = 1;

    _.each(collection, function(element) {
        html += renderFunction(element, id);
        id++;
    });

    $(targetDiv).html(html);
}

teaming.renderPersonTemplate = function(person, id) {
    var template = $('#personTemplate').html();
    Mustache.parse(template);

    return Mustache.render(template, {id: "drag" + id, img: person.image, name: person.name, position: person.position, notes: person.notes});
};

teaming.renderTeamTemplate = function(team, id) {
    var template = $('#teamTemplate').html();
    Mustache.parse(template);

    return Mustache.render(template, {id: "team" + id, teamName: team.name, roles: team.roles});
};

teaming.renderScenarioTemplate = function(id, name) {
    var template = $('#scenarioTemplate').html();
    Mustache.parse(template);

    return Mustache.render(template, {id: id, scenarioName: name});
};

function editPerson (id) {
    var personModal = $("#personModal");
    var card = $("#" + id);

    $('#personId', personModal).val(id);
    $('#name2', personModal).val(card.find(".person-name").html());
    $('#title', personModal).val(card.find(".person-position").html());
    $('#notes', personModal).val(card.find(".person-notes").html());

    $('#myModalLabel2', personModal).html("Edit Person");
    $('#addPersonButton', personModal).html("Save");
};

function editTeam(id) {
    var teamModal = $("#teamModal");
    var team = $("#" + id);
    $('#teamId', teamModal).val(id);
    $('#name', teamModal).val(team.find(".team-name").html());
    var roles = "";
    var rolesHtml = team.find(".team-role");

    $(rolesHtml).each(function(index, item){roles += $(item).html() + "," })
    roles = roles.substr(0, roles.length - 1);
    $('#roles', teamModal).val(roles);

    $('#myModalLabel', teamModal).html("Edit Team");
    $('#addTeamButton', teamModal).html("Save");
};

function popScenarioModal() {
  var scenarioModal = $("#scenarioModal");
  $('#scenario-name', scenarioModal).val("");
};

function addPersonModal() {
  var personModal = $("#personModal");

  $('#personId', personModal).val("");
  $('#name2', personModal).val("");
  $('#title', personModal).val("");
  $('#notes', personModal).val("");

  $('#myModalLabel2', personModal).html("Add Person");
  $('#addPersonButton', personModal).html("Add Person");
};

function addTeamModal() {
  var teamModal = $("#teamModal");

  $('#name', teamModal).val("");
  $('#roles', teamModal).val("");
  $('#teamId', teamModal).val("");

  $('#myModalLabel', teamModal).html("Add Team");
  $('#addTeamButton', teamModal).html("Add Team");
};

function addPerson() {
  var person_name = $('#name2').val();
  var person_title = $('#title').val();
  var notes = $('#notes').val();

  var person_id = $('#personId').val();

  if(person_id != "") {
    var card = $('#' + person_id);
    card.find(".person-name").html(person_name);
    card.find(".person-position").html(person_title);
    card.find(".person-notes").html(notes);
  } else {
    var person = {
        "name": person_name,
        "image": "images/new.jpg",
        "position": person_title,
        "notes":notes
    };

    teaming.addNewPerson(person);
  }
  var personModal = $("#personModal");
  personModal.modal({ show: false });

  $('#closeAddPersonModal').trigger('click');
};

function addTeam() {
    var name = $('#name').val();
    var roles = $('#roles').val().split(",");
    var team_id = $('#teamId').val();

    var team = {
        "name":name,
        "roles": roles
    }

    if(team_id != "") {
        var cards = $('#' + team_id).find("div.card");
        var proceed = confirm("This changes will remove every person from the team. Do you want to proceed?");
        if(proceed) {
            $(cards).each(function(index, item){
                $(item).appendTo("#peopleDiv");
            });
            $('#' + team_id).html(teaming.renderTeamTemplate(team, team_id));
        }
    } else {
      teaming.addNewTeam(team);
    }
    $('#closeAddTeamModal').trigger('click');
};

$(window).load(function(){
  teaming.renderTeams();
  teaming.renderPeople();

  $('#confirm-delete').on('show.bs.modal', function(e) {
      $(this).find('.btn-ok').attr('onclick', $(e.relatedTarget).data('href'));
  });

  restoreScenarios();
  setupDragAndDrop();
});

function setupDragAndDrop() {
  $( "#scenariosContainer" ).sortable({
    update: function() {
      saveScenariosContainerState();
    }
  });
  $( "#scenariosContainer" ).disableSelection();
}

function allowDrop(ev) {
  ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData("text/plain", ev.target.id);
}

function drop(ev, el) {
  ev.preventDefault();
  var data = ev.dataTransfer.getData("text");
  if($(el).attr('id') == "peopleDiv" || el.children.length == 0){
    el.appendChild(document.getElementById(data));
  }
}

function saveScenario() {
  var id = "scenario_" + guid();

  var scenarioName = $('#scenario-name').val();

  $('#scenariosContainer').append(teaming.renderScenarioTemplate(id, scenarioName));
  storeState(id);
  $('#closeScenarioModal').trigger('click');
}

function restoreScenarios() {
  $("#scenariosContainer").html(localStorage.getItem("scenariosContainer"));

  setupDragAndDrop();
}

function storeState(id) {
  localStorage.setItem(id, $("#body").html());
  saveScenariosContainerState();
}

function restoreState(id) {
  $("#body").html(localStorage.getItem(id));
  restoreScenarios();
}

function deleteAll() {
  // var proceed = confirm("Are you sure to delete all scenarios?");
  // if(proceed) {
    localStorage.clear();
    location.reload();
    $('#closeConfirmDeleteModal').trigger('click');
  // }
}

function deleteState(id) {
  $("#" + id).remove();
  localStorage.removeItem(id);
  saveScenariosContainerState();
  $('#closeConfirmDeleteModal').trigger('click');
}

function saveScenariosContainerState() {
  localStorage.setItem("scenariosContainer", $("#scenariosContainer").html());
}

function guid() {
  function s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
    s4() + '-' + s4() + s4() + s4();
}

function deleteTeam(id){
  var cards = $('#' + id).find("div.card");
  $(cards).each(function(index, item){
    $(item).appendTo("#peopleDiv");
  });

  $("#" + id).remove();
  $('#closeConfirmDeleteModal').trigger('click');
}

function deletePerson(id){
  $("#" + id).remove();
  $('#closeConfirmDeleteModal').trigger('click');
}

function saveExportFile(){
    var blob = new Blob([JSON.stringify(localStorage)], {type: 'application/json;charset=utf-8'});
    saveAs(blob, 'export.ponyak');
}

function clearAllData(){
    if (confirm('This will clear all data from your current session. Are you sure?')) {
        loadApplicationState({});
    }
}

function loadApplicationState(newData) {
    localStorage.clear();
    newData = newData || {};
    Object.keys(newData).forEach(function(key){
        var value = newData[key];
        localStorage.setItem(key, value);
    });
    location.reload();
}

function importFromFile(input){
    if (input.files && input.files[0]) {
        var file = input.files[0];
        var reader = new FileReader();
        reader.onload = function(event){
            var contents = event.target.result;
            var data = JSON.parse(contents);
            console.log(data);
            loadApplicationState(data);
        };
        reader.readAsText(file);
    }
}

function promptForFile(){
    $('#file').click();
}
